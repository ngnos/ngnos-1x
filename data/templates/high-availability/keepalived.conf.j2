# Autogenerated by ngNOS
# Do not edit this file, all your changes will be lost
# on next commit or reboot

# Global definitions configuration block
global_defs {
    dynamic_interfaces
    script_user root
{% if vrrp.global_parameters.startup_delay is ngnos_defined %}
    vrrp_startup_delay {{ vrrp.global_parameters.startup_delay }}
{% endif %}
{% if vrrp.global_parameters.garp is ngnos_defined %}
{%     if vrrp.global_parameters.garp.interval is ngnos_defined %}
    vrrp_garp_interval {{ vrrp.global_parameters.garp.interval }}
{%     endif %}
{%     if vrrp.global_parameters.garp.master_delay is ngnos_defined %}
    vrrp_garp_master_delay {{ vrrp.global_parameters.garp.master_delay }}
{%     endif %}
{%     if vrrp.global_parameters.garp.master_refresh is ngnos_defined %}
    vrrp_garp_master_refresh {{ vrrp.global_parameters.garp.master_refresh }}
{%     endif %}
{%     if vrrp.global_parameters.garp.master_refresh_repeat is ngnos_defined %}
    vrrp_garp_master_refresh_repeat {{ vrrp.global_parameters.garp.master_refresh_repeat }}
{%     endif %}
{%     if vrrp.global_parameters.garp.master_repeat is ngnos_defined %}
    vrrp_garp_master_repeat {{ vrrp.global_parameters.garp.master_repeat }}
{%     endif %}
{% endif %}
    notify_fifo /run/keepalived/keepalived_notify_fifo
    notify_fifo_script /usr/libexec/ngnos/system/keepalived-fifo.py
}

{% if vrrp.group is ngnos_defined %}
{%     for name, group_config in vrrp.group.items() if group_config.disable is not ngnos_defined %}
{%         if group_config.health_check.script is ngnos_defined %}
vrrp_script healthcheck_{{ name }} {
    script "{{ group_config.health_check.script }}"
    interval {{ group_config.health_check.interval }}
    fall {{ group_config.health_check.failure_count }}
    rise 1
}
{%         endif %}
vrrp_instance {{ name }} {
{%         if group_config.description is ngnos_defined %}
    # {{ group_config.description }}
{%         endif %}
    state BACKUP
    interface {{ group_config.interface }}
    virtual_router_id {{ group_config.vrid }}
    priority {{ group_config.priority }}
    advert_int {{ group_config.advertise_interval }}
{%         if group_config.garp is ngnos_defined %}
{%             if group_config.garp.interval is ngnos_defined %}
    garp_interval {{ group_config.garp.interval }}
{%             endif %}
{%             if group_config.garp.master_delay is ngnos_defined %}
    garp_master_delay {{ group_config.garp.master_delay }}
{%             endif %}
{%             if group_config.garp.master_repeat is ngnos_defined %}
    garp_master_repeat {{ group_config.garp.master_repeat }}
{%             endif %}
{%             if group_config.garp.master_refresh is ngnos_defined %}
    garp_master_refresh {{ group_config.garp.master_refresh }}
{%             endif %}
{%             if group_config.garp.master_refresh_repeat is ngnos_defined %}
    garp_master_refresh_repeat {{ group_config.garp.master_refresh_repeat }}
{%             endif %}
{%         endif %}
{%         if group_config.track.exclude_vrrp_interface is ngnos_defined %}
    dont_track_primary
{%         endif %}
{%         if group_config.no_preempt is not ngnos_defined and group_config.preempt_delay is ngnos_defined %}
    preempt_delay {{ group_config.preempt_delay }}
{%         elif group_config.no_preempt is ngnos_defined %}
    nopreempt
{%         endif %}
{%         if group_config.peer_address is ngnos_defined %}
    unicast_peer { {{ group_config.peer_address }} }
{%         endif %}
{%         if group_config.hello_source_address is ngnos_defined %}
{%             if group_config.peer_address is ngnos_defined %}
    unicast_src_ip {{ group_config.hello_source_address }}
{%             else %}
    mcast_src_ip {{ group_config.hello_source_address }}
{%             endif %}
{%         endif %}
{%         if group_config.rfc3768_compatibility is ngnos_defined and group_config.peer_address is ngnos_defined %}
    use_vmac {{ group_config.interface }}v{{ group_config.vrid }}v{{ '4' if group_config['address'] | first | is_ipv4 else '6' }}
    vmac_xmit_base
{%         elif group_config.rfc3768_compatibility is ngnos_defined %}
    use_vmac {{ group_config.interface }}v{{ group_config.vrid }}v{{ '4' if group_config['address'] | first | is_ipv4 else '6' }}
{%         endif %}
{%         if group_config.authentication is ngnos_defined %}
    authentication {
        auth_pass "{{ group_config.authentication.password }}"
{%             if group_config.authentication.type is ngnos_defined('plaintext-password') %}
        auth_type PASS
{%             else %}
        auth_type {{ group_config.authentication.type | upper }}
{%             endif %}
    }
{%         endif %}
{%         if group_config.address is ngnos_defined %}
    virtual_ipaddress {
{%             for addr, addr_config in group_config.address.items() %}
        {{ addr }}{{ ' dev ' + addr_config.interface if addr_config.interface is ngnos_defined }}
{%             endfor %}
    }
{%         endif %}
{%         if group_config.excluded_address is ngnos_defined %}
    virtual_ipaddress_excluded {
{%             for addr in group_config.excluded_address %}
        {{ addr }}
{%             endfor %}
    }
{%         endif %}
{%         if group_config.track.interface is ngnos_defined %}
    track_interface {
{%             for interface in group_config.track.interface %}
        {{ interface }}
{%             endfor %}
    }
{%         endif %}
{%         if group_config.health_check.script is ngnos_defined %}
    track_script {
        healthcheck_{{ name }}
    }
{%         endif %}
}
{%     endfor %}
{% endif %}

{% if vrrp.sync_group is ngnos_defined %}
{%     for name, sync_group_config in vrrp.sync_group.items() if sync_group_config.disable is not ngnos_defined %}
vrrp_sync_group {{ name }} {
    group {
{%         if sync_group_config.member is ngnos_defined %}
{%             for member in sync_group_config.member %}
        {{ member }}
{%             endfor %}
{%         endif %}
    }

{# Health-check scripts should be in section sync-group if member is part of the sync-group T4081 #}
{%         if vrrp.group is ngnos_defined %}
{%             for name, group_config in vrrp.group.items() if group_config.disable is not ngnos_defined %}
{%                 if group_config.health_check.script is ngnos_defined and name in sync_group_config.member %}
    track_script {
        healthcheck_{{ name }}
    }
{%                 endif %}
{%             endfor %}
{%         endif %}
{%         if conntrack_sync_group is ngnos_defined(name) %}
{%             set ngnos_helper = "/usr/libexec/ngnos/ngnos-vrrp-conntracksync.sh" %}
    notify_master "{{ ngnos_helper }} master {{ name }}"
    notify_backup "{{ ngnos_helper }} backup {{ name }}"
    notify_fault "{{ ngnos_helper }} fault {{ name }}"
{%         endif %}
}
{%     endfor %}
{% endif %}

{% if virtual_server is ngnos_defined %}
# Virtual-server configuration
{%     for vserver, vserver_config in virtual_server.items() %}
# Vserver {{ vserver }}
{%         if vserver_config.port is ngnos_defined %}
virtual_server {{ vserver }} {{ vserver_config.port }} {
{%         else %}
virtual_server fwmark {{ vserver_config.fwmark }} {
{%         endif %}
    delay_loop {{ vserver_config.delay_loop }}
{%         if vserver_config.algorithm is ngnos_defined('round-robin') %}
    lb_algo rr
{%         elif vserver_config.algorithm is ngnos_defined('weighted-round-robin') %}
    lb_algo wrr
{%         elif vserver_config.algorithm is ngnos_defined('least-connection') %}
    lb_algo lc
{%         elif vserver_config.algorithm is ngnos_defined('weighted-least-connection') %}
    lb_algo wlc
{%         elif vserver_config.algorithm is ngnos_defined('source-hashing') %}
    lb_algo sh
{%         elif vserver_config.algorithm is ngnos_defined('destination-hashing') %}
    lb_algo dh
{%         elif vserver_config.algorithm is ngnos_defined('locality-based-least-connection') %}
    lb_algo lblc
{%         endif %}
{%         if vserver_config.forward_method is ngnos_defined('nat') %}
    lb_kind NAT
{%         elif vserver_config.forward_method is ngnos_defined('direct') %}
    lb_kind DR
{%         elif vserver_config.forward_method is ngnos_defined('tunnel') %}
    lb_kind TUN
{%         endif %}
    persistence_timeout {{ vserver_config.persistence_timeout }}
    protocol {{ vserver_config.protocol | upper }}
{%         if vserver_config.real_server is ngnos_defined %}
{%             for rserver, rserver_config in vserver_config.real_server.items() %}
    real_server {{ rserver }} {{ rserver_config.port }} {
        weight 1
{%                 if rserver_config.health_check.script is ngnos_defined %}
        MISC_CHECK {
            misc_path {{ rserver_config.health_check.script }}
{%                 else %}
        {{ vserver_config.protocol | upper }}_CHECK {
{%                     if rserver_config.connection_timeout is ngnos_defined %}
            connect_timeout {{ rserver_config.connection_timeout }}
{%                     endif %}
{%                 endif %}
        }
    }
{%             endfor %}
{%         endif %}
}
{%     endfor %}
{% endif %}
